import"./base.D1hT_OMg.js";/* empty css                   */import{E as k}from"./index.BeWdm9wy.js";import"./framework.CCndWvNN.js";import"./index.DT7TJvLG.js";import"./index.B1pLMPru.js";import"./isSymbol.C7jn4vLP.js";import"./isObject.C3e4t58V.js";import"./types.BG7Bq31m.js";import"./index.dVC2hAAQ.js";import"./icon.ZlYHZ6bL.js";import"./index.l2C8AFQu.js";import"./typescript.Bp3YSIOJ.js";import"./use-global-config.Cy85fLye.js";import"./index.CQNcN25s.js";import"./index.BTWm3S8P.js";import"./aria.9SHySdGF.js";async function R(o,n){const r=o.getReader();let t;for(;!(t=await r.read()).done;)n(t.value)}function _(o){let n,r,t,i=!1;return function(s){n===void 0?(n=s,r=0,t=-1):n=H(n,s);const e=n.length;let a=0;for(;r<e;){i&&(n[r]===10&&(a=++r),i=!1);let c=-1;for(;r<e&&c===-1;++r)switch(n[r]){case 58:t===-1&&(t=r-a);break;case 13:i=!0;case 10:c=r;break}if(c===-1)break;o(n.subarray(a,c),t),a=r,t=-1}a===e?n=void 0:a!==0&&(n=n.subarray(a),r-=a)}}function D(o,n,r){let t=x();const i=new TextDecoder;return function(s,e){if(s.length===0)r==null||r(t),t=x();else if(e>0){const a=i.decode(s.subarray(0,e)),c=e+(s[e+1]===32?2:1),d=i.decode(s.subarray(c));switch(a){case"data":t.data=t.data?t.data+`
`+d:d;break;case"event":t.event=d;break;case"id":o(t.id=d);break;case"retry":const u=parseInt(d,10);isNaN(u)||n(t.retry=u);break}}}}function H(o,n){const r=new Uint8Array(o.length+n.length);return r.set(o),r.set(n,o.length),r}function x(){return{data:"",event:"",id:"",retry:void 0}}var W=function(o,n){var r={};for(var t in o)Object.prototype.hasOwnProperty.call(o,t)&&n.indexOf(t)<0&&(r[t]=o[t]);if(o!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,t=Object.getOwnPropertySymbols(o);i<t.length;i++)n.indexOf(t[i])<0&&Object.prototype.propertyIsEnumerable.call(o,t[i])&&(r[t[i]]=o[t[i]]);return r};const y="text/event-stream",F=1e3,T="last-event-id";function J(o,n){var{signal:r,headers:t,onopen:i,onmessage:f,onclose:s,onerror:e,openWhenHidden:a,fetch:c}=n,d=W(n,["signal","headers","onopen","onmessage","onclose","onerror","openWhenHidden","fetch"]);return new Promise((u,C)=>{const p=Object.assign({},t);p.accept||(p.accept=y);let m;function j(){m.abort(),document.hidden||g()}a||document.addEventListener("visibilitychange",j);let S=F,v=0;function b(){document.removeEventListener("visibilitychange",j),window.clearTimeout(v),m.abort()}r==null||r.addEventListener("abort",()=>{b(),u()});const N=c??window.fetch,A=i??L;async function g(){var E;m=new AbortController;try{const h=await N(o,Object.assign(Object.assign({},d),{headers:p,signal:m.signal}));await A(h),await R(h.body,_(D(l=>{l?p[T]=l:delete p[T]},l=>{S=l},f))),s==null||s(),b(),u()}catch(h){if(!m.signal.aborted)try{const l=(E=e==null?void 0:e(h))!==null&&E!==void 0?E:S;window.clearTimeout(v),v=window.setTimeout(g,l)}catch(l){b(),C(l)}}}g()})}function L(o){const n=o.headers.get("content-type");if(!(n!=null&&n.startsWith(y)))throw new Error(`Expected content-type to be ${y}, Actual: ${n}`)}class O extends Error{}class I extends Error{}class P extends Error{}class w extends Error{}async function oe({url:o,data:n,method:r="post",headers:t={},onMessage:i,signal:f,onUnLogin:s}){try{await J(o,{signal:f,method:r,headers:{"Content-Type":"application/json",Authorization:localStorage.getItem("token"),...t},body:JSON.stringify(n),async onopen(e){var a;if(!(e.ok&&((a=e.headers.get("content-type"))!=null&&a.includes(y)))){if(e.status===401)throw new I("登录过期");if(e.status>=400&&e.status<500&&e.status!==429)throw new P;{const c=await e.json();throw new O(c.data)}}},onmessage(e){const a=JSON.parse(e.data||"{}");if(a.content==="[STREAM_DONE]")throw new w(a);i==null||i(a)},onclose(){const e="连接已关闭";throw new w(e)},onerror(e){throw e instanceof I&&(s==null||s()),e instanceof P||e instanceof w||console.warn("sse异常中断"),e},openWhenHidden:!0})}catch(e){return e instanceof w?Promise.resolve(e.message):e instanceof O?(k.error(e.message),Promise.reject(e)):(e instanceof O?k.error(e.message):console.warn(e),Promise.reject(e))}}export{w as DoneState,P as FatalError,I as LoginError,O as RetriableError,oe as fetchEvent};
